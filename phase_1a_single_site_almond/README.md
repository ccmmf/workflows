# CCMMF phase 1a: Single-site almond MVP


 This workflow shows PEcAn running Sipnet hindcast simulations of an almond orchard in Kern County, CA. Starting from estimated initial conditions at orchard planting in 1999, we simulate 14 years of growth using PEcAn's existing Sipnet parameterization for a temperate deciduous forest, with no management activities included.

 The workflow has  the following components, run in this order:

* TKTK installation and system setup.
  - You will need at least a compiled Sipnet binary from https://github.com/PecanProject/sipnet, a working installation of the PEcAn R packages from https://github.com/PecanProject/pecan or from https://pecanproject.r-universe.org, and some system libraries they depend on. Instructions for obtaining these are TK.
* Input prep steps, for which we provide output files in `00_cccmmf_phase_1a_artifacts.tgz` that can be recreated or altered using these scripts plus the prerequisite files documented [below](#artifacts-needed-before-running-the-model).
  - `01_prep_get_ERA5_met.R` extracts site met data from a locally downloaded copy of the ERA5 ensemble and writes it in Sipnet's clim format.
  - `02_prep_add_precip_to_clim_files.sh` artificially adds precipitation to the Sipnet clim files, crudely approximating irrigation.
  - `03_prep_ic_build.R` extracts initial aboveground carbon from a locally downloaded LandTrendr biomass map, retrieves initial soil moisture anbd soil organic carbon, and samples from all of these to create initial condition files.
* Run Sipnet on the prepared inputs.
  - `04_run_model.R` and its input file `single_site_almond.xml` runs an ensemble of 100 Sipnet simulations sampling from the uncertainty in weather, initial biomass and soil conditions, and parameter values. It also performs a one-at-a-time sensitivity analysis on the parameters and creates visualizations of the results. Run it as `./04_run_model.R --settings=single_site_almond.xml 2>&1 | tee pecan_workflow_runlog.txt`
* Analyze the results.
  - `05_validation.Rmd` shows validation comparisons between the model predictions and site-level measurements of SOC, biomass, NPP, and ET.


## System setup TK

More details will go here about installation options.


## Artifacts needed before running the model

We provide these as a single file named `00_cccmmf_phase_1a_artifacts.tgz` [TODO this name may change!]. Unpack it into the project directory (i.e. alongside this README) and it will place its files at the paths documented below.


### 1. Posterior files for PFT-specific model parameters

These were generated by PEcAn, but we treat them as prerequisites here because running calibration to set parameter distributions is a complex offline process. The posterior files used here were calibrated in Fer et al 2018[1] and are the Dietze lab's standard posterior for simulations of temperate deciduous woody plants:

* `pfts/temperate/post.distns.Rdata`, md5 = 8783b81a32665b0a1f3405e4711124f6
* `pfts/temperate/trait.mcmc.Rdata`, md5 = 8cd3f36a64d9005ed1aeba3f2fd537bd

To relocate these paths or use a different posterior file, edit `settings$pfts$pft$posterior.files`.


### 2. Site-specific climate driver files for SIPNET

This should be a single flat folder containing ten `*.clim` files, one per ERA5 ensemble member; PEcAn will sample from these to choose the met input for each Sipnet ensemble member.

If you have raw ERA5 data in hand, you can generate these files with `01_prep_get_ERA5_met.R` -- See there for details. We provide them as artifacts because at this writing the official ERA5 data API is unstable in both availability and returned file format and has been that way for at least three months, so we decided a tarball of clim files would be more reproducible than a download script.

Here we use `ERA5_losthills_SIPNET/*.clim`:
```
MD5 (ERA5_losthills_SIPNET/ERA5.1.1999-01-01.2012-12-31.clim) = 9d7222037a3cac0283a3678de760fb31
MD5 (ERA5_losthills_SIPNET/ERA5.10.1999-01-01.2012-12-31.clim) = 9fb9911aa3278cc30ed66d413e2a2d03
MD5 (ERA5_losthills_SIPNET/ERA5.2.1999-01-01.2012-12-31.clim) = ed09f7d2e32fab5c155e5f530e4f26c5
MD5 (ERA5_losthills_SIPNET/ERA5.3.1999-01-01.2012-12-31.clim) = a947ab953e576706e743856806f66b36
MD5 (ERA5_losthills_SIPNET/ERA5.4.1999-01-01.2012-12-31.clim) = a9252528bc300c2bfdd6377c9a8b7372
MD5 (ERA5_losthills_SIPNET/ERA5.5.1999-01-01.2012-12-31.clim) = f54262ffcb927225ac47375f574340f9
MD5 (ERA5_losthills_SIPNET/ERA5.6.1999-01-01.2012-12-31.clim) = 6e06d46bd90e93c99b62c57b53eeb090
MD5 (ERA5_losthills_SIPNET/ERA5.7.1999-01-01.2012-12-31.clim) = f90b17acced9270908c9e377edf18888
MD5 (ERA5_losthills_SIPNET/ERA5.8.1999-01-01.2012-12-31.clim) = 3731fc19670653c0cf701c2e859412a4
MD5 (ERA5_losthills_SIPNET/ERA5.9.1999-01-01.2012-12-31.clim) = 1dee5bc0b42207edeb535ca7fc3c3c3c
```

To relocate these files or use different ones, edit the input path in `02_prep_add_precip_to_clim_files.sh`, or if not altering precip then edit the paths in `settings$inputs$met$path`.


### 3. Site-specific initial condition files

Create as many as you need to capture the variability in known/assumed site conditions at the start of the run.
The number of IC files need not be the same as the ensemble size; each ensemble member samples with replacement to select initial conditions.
Generate these with `03_prep_ic_build.R`, which sets
  - Aboveground biomass from LandTrendr
    (You must first download raw LandTrendr tiles and specify the path to them)
  - Soil moisture from Copernicus 0.25 degree gridded multi-satellite data
    (You must first set up a CDS API key, then this script handles download)
  - 0-30 cm soil organic carbon stock from SoilGrids 250m data
    (this script handles download)
See `03_prep_ic_build.R` for details.

Here we store:
* Initial condition files in `IC_files/losthills/*.nc`, whose collective md5 hash (i.e. `md5 IC_files/losthills/*.nc | md5`) is da8efa69af2d5e22efcdc4541942ee64
* Source data for aboveground biomass in `LandTrendr_AGB/`
```
MD5 (LandTrendr_AGB/aboveground_biomass_landtrendr.csv) = 60b264c272656af7149c00813f17f97c
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h02v08.tif) = 41aeada58b5224ccf450fa22536edd67
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h03v10.tif) = 716488ac4befc35be3b11973700da92a
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h03v11.tif) = 5afceed07c8836a82e3e8f25e7f3e76b
```
- Source data for soil moisture in `soil_moisture/`
```
MD5 (soil_moisture/sm.csv) = ea064b8eb8be77a4a1669f52062bf48c
MD5 (soil_moisture/surface_soil_moisture.1999-01-01.nc) = 70fad74c167e1809fe6b35a0baa0b004
MD5 (soil_moisture/surface_soil_moisture.1999-01-02.nc) = 03052e99496f95e76e462385ff14e875
MD5 (soil_moisture/surface_soil_moisture.1999-01-03.nc) = ebf9eeb15fb01e0f3faafd937b1992bf
MD5 (soil_moisture/surface_soil_moisture.1999-01-04.nc) = c2337eaa91d96d3f55222e289326fe02
MD5 (soil_moisture/surface_soil_moisture.1999-01-05.nc) = 05dbc0a64eda1b255d39629d3d0ac052
MD5 (soil_moisture/surface_soil_moisture.1999-01-06.nc) = 5866d52333c9486ae2bed6431182bbf7
MD5 (soil_moisture/surface_soil_moisture.1999-01-07.nc) = afbc760887d752037ed0af1b5a32dab1
MD5 (soil_moisture/surface_soil_moisture.1999-01-08.nc) = ecd332b20d87d31a03a23d22cddb0844
MD5 (soil_moisture/surface_soil_moisture.1999-01-09.nc) = 4870a69bd7594e41d9015888dd50d116
MD5 (soil_moisture/surface_soil_moisture.1999-01-10.nc) = 2337043bee7e185a957cd8cb92062234
```
- compiled soil C stock data in `soilgrids_soilC_data.csv`, MD5 = cc03b81f5a636b9584ee1b03a7a9ed3e

TODO these output paths are kind of scattered. Consider centralizing them -- maybe set outdir to `IC_files` instead of `.` in `03_prep_ic_build.R`?


## References

[1] Fer I, R Kelly, P Moorcroft, AD Richardson, E Cowdery, MC Dietze. 2018. Linking big models to big data: efficient ecosystem model calibration through Bayesian model emulation. Biogeosciences 15, 5801â€“5830, 2018 https://doi.org/10.5194/bg-15-5801-2018
