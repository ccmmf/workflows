# CCMMF phase 1a: Single-site almond MVP


 This workflow shows PEcAn running Sipnet hindcast simulations of an almond orchard in Kern County, CA. Starting from estimated initial conditions at orchard planting in 1999, we simulate 14 years of growth using PEcAn's existing Sipnet parameterization for a temperate deciduous forest, with no management activities included.

 The workflow has the following components, run in this order:

* TKTK installation and system setup.
  - You will need at least a compiled Sipnet binary from https://github.com/PecanProject/sipnet, a working installation of the PEcAn R packages from https://github.com/PecanProject/pecan or from https://pecanproject.r-universe.org, and some system libraries they depend on. Instructions for obtaining these are TK.
* Input prep steps, for which we provide output files in `00_ccmmf_phase_1a_artifacts.tgz` that can be recreated or altered using these scripts plus the prerequisite files documented [below](#artifacts-needed-before-running-the-model).
  - `01_prep_get_ERA5_met.R` extracts site met data from a locally downloaded copy of the ERA5 ensemble and writes it in Sipnet's clim format.
  - `02_prep_add_precip_to_clim_files.sh` artificially adds precipitation to the Sipnet clim files, crudely approximating irrigation.
  - `03_prep_ic_build.R` extracts initial aboveground carbon from a locally downloaded LandTrendr biomass map, retrieves initial soil moisture anbd soil organic carbon, and samples from all of these to create initial condition files.
* Run Sipnet on the prepared inputs.
  - `04_run_model.R` and its input file `single_site_almond.xml` runs an ensemble of 100 Sipnet simulations sampling from the uncertainty in weather, initial biomass and soil conditions, and parameter values. It also creates visualizations of the results, and can perform a one-at-a-time sensitivity analysis on the parameters (but this is turned off by default for speed. To enable it, uncomment the `sensitivity.analysis` section of `single_site.almond.xml`). Run it as `./04_run_model.R --settings=single_site_almond.xml 2>&1 | tee pecan_workflow_run.log`.
* Analyze the results.
  - `05_validation.Rmd` shows validation comparisons between the model predictions and site-level measurements of SOC, biomass, NPP, and ET.
* Archive run outputs.
  - `tools/compress_output.sh` creates a compressed tarball of the `outputs/` directory, the compiled validation notebook, and any log files.

## System setup TK

More details will go here about installation options.


## Artifacts needed before running the model

We provide these as a single file named `00_cccmmf_phase_1a_input_artifacts.tgz` [TODO this name may change!]. Unpack it into the project directory (`cd your/path/to/phase_1a_single_site_almond && tar xf 00_cccmmf_phase_1a_input_artifacts.tgz`) and it will place its files at the paths documented below.


### 1. Posterior files for PFT-specific model parameters

These were generated by PEcAn, but we treat them as prerequisites here because running calibration to set parameter distributions is a complex offline process. The posterior files used here were calibrated in Fer et al 2018[1] and are the Dietze lab's standard posterior for simulations of temperate deciduous woody plants:

* `pfts/temperate/post.distns.Rdata`, md5 = 8783b81a32665b0a1f3405e4711124f6
* `pfts/temperate/trait.mcmc.Rdata`, md5 = 8cd3f36a64d9005ed1aeba3f2fd537bd

To relocate these paths or use a different posterior file, edit `settings$pfts$pft$posterior.files`.


### 2. Site-specific climate driver files for SIPNET

This should be a single flat folder containing ten `*.clim` files, one per ERA5 ensemble member; PEcAn will sample from these to choose the met input for each Sipnet ensemble member.

If you have raw ERA5 data in hand, you can generate these files with `01_prep_get_ERA5_met.R` -- See there for details. We provide them as artifacts because at this writing the official ERA5 data API is unstable in both availability and returned file format and has been that way for at least three months, so we decided a tarball of clim files would be more reproducible than a download script.

Here we use `data/ERA5_losthills_dailyrain/*.clim`:
```
MD5 (ERA5.1.1999-01-01.2012-12-31.clim) = e61481d71dfa39533932e0c1bcdb35fb
MD5 (ERA5.10.1999-01-01.2012-12-31.clim) = 45e096d5ff23f59d5fedc653f6bef654
MD5 (ERA5.2.1999-01-01.2012-12-31.clim) = 484b84269f5fc41f8808ad4321cf6188
MD5 (ERA5.3.1999-01-01.2012-12-31.clim) = 1f1e3a53c98aff3f2f1fa0f3e234c5e5
MD5 (ERA5.4.1999-01-01.2012-12-31.clim) = fc90db406522a94d47b66a20e16c9f5e
MD5 (ERA5.5.1999-01-01.2012-12-31.clim) = 0b6ad1e96b1bd30d61800880fa0e37ef
MD5 (ERA5.6.1999-01-01.2012-12-31.clim) = 1844ac3be2d3b9fea17b471c77908df1
MD5 (ERA5.7.1999-01-01.2012-12-31.clim) = bee6b863d2e23d55211e9f5df4e70fa5
MD5 (ERA5.8.1999-01-01.2012-12-31.clim) = 0be2f00cad34562bd5b6823a445034f3
MD5 (ERA5.9.1999-01-01.2012-12-31.clim) = ac18e8d57a68e6aa5457cd7cf7e6892b
```

To relocate these files or use different ones, edit the input path in `02_prep_add_precip_to_clim_files.sh`, or if not altering precip then edit the paths in `settings$inputs$met$path`.


### 3. Site-specific initial condition files

Create as many as you need to capture the variability in known/assumed site conditions at the start of the run.
The number of IC files need not be the same as the ensemble size; each ensemble member samples with replacement to select initial conditions.
Generate these with `03_prep_ic_build.R`, which sets
  - Aboveground biomass from LandTrendr
    (You must first download raw LandTrendr tiles and specify the path to them)
  - Soil moisture from Copernicus 0.25 degree gridded multi-satellite data
    (You must first set up a CDS API key, then this script handles download)
  - 0-30 cm soil organic carbon stock from SoilGrids 250m data
    (this script handles download)
See `03_prep_ic_build.R` for details.

Here we store:
* Initial condition files in `IC_files/losthills/*.nc`, whose collective md5 hash (i.e. `md5 IC_files/losthills/*.nc | md5`) is da8efa69af2d5e22efcdc4541942ee64
* Source data for aboveground biomass in `data_raw/LandTrendr_AGB/`
```
MD5 (LandTrendr_AGB/aboveground_biomass_landtrendr.csv) = 60b264c272656af7149c00813f17f97c
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h02v08.tif) = 41aeada58b5224ccf450fa22536edd67
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h03v10.tif) = 716488ac4befc35be3b11973700da92a
MD5 (LandTrendr_AGB/conus_biomass_ARD_tile_h03v11.tif) = 5afceed07c8836a82e3e8f25e7f3e76b
```
* Source data for soil moisture in `data/IC_prep/soil_moisture/`
```
MD5 (soil_moisture/sm.csv) = ea064b8eb8be77a4a1669f52062bf48c
MD5 (soil_moisture/surface_soil_moisture.1999-01-01.nc) = 70fad74c167e1809fe6b35a0baa0b004
MD5 (soil_moisture/surface_soil_moisture.1999-01-02.nc) = 03052e99496f95e76e462385ff14e875
MD5 (soil_moisture/surface_soil_moisture.1999-01-03.nc) = ebf9eeb15fb01e0f3faafd937b1992bf
MD5 (soil_moisture/surface_soil_moisture.1999-01-04.nc) = c2337eaa91d96d3f55222e289326fe02
MD5 (soil_moisture/surface_soil_moisture.1999-01-05.nc) = 05dbc0a64eda1b255d39629d3d0ac052
MD5 (soil_moisture/surface_soil_moisture.1999-01-06.nc) = 5866d52333c9486ae2bed6431182bbf7
MD5 (soil_moisture/surface_soil_moisture.1999-01-07.nc) = afbc760887d752037ed0af1b5a32dab1
MD5 (soil_moisture/surface_soil_moisture.1999-01-08.nc) = ecd332b20d87d31a03a23d22cddb0844
MD5 (soil_moisture/surface_soil_moisture.1999-01-09.nc) = 4870a69bd7594e41d9015888dd50d116
MD5 (soil_moisture/surface_soil_moisture.1999-01-10.nc) = 2337043bee7e185a957cd8cb92062234
```
* compiled soil C stock data in `data/IC_prep/soilgrids_soilC_data.csv`, MD5 = cc03b81f5a636b9584ee1b03a7a9ed3e


### tar command

For the record, we packaged all of the above inputs using:

```
tar czf 00_cccmmf_phase_1a_input_artifacts.tgz \
  pfts/temperate/ \
  data/ERA5_losthills_dailyrain/ \
  IC_files/losthills/
```

## Directory layout

The files for this project are arranged as follows. Note that some of these are created at runtime and will not be visible when looking at the project code on GitHub.

- `data/`: Clean, processed datasets used for model input and validation. Files in this directory can be recreated with the appropriate prep script.
- `data_raw/`: Datasets that were created by workflows external to this project, potentially including manual compilation. Files in this directory should be treated as artifacts that would be a lot of work to recreate.
- `IC_files/`: Initial conditions for the site(s) to be modeled, stored as netCDF files. Each file contains a single starting value for each variable, drawn from the distributions estimated in the `ic_build` script. Each model invocation (ensemble member) then begins from the initial conditions in one file.
- `output/`: Created by PEcAn at run time. Contains:
  - `ensemble.analysis.<id>.<variable>.<years>.pdf`: histograms and boxplots of the time-averaged ensemble values of each variable.
  - `ensemble.output.<id>.<variable>.<years>.Rdata`: The extracted datapoints used to make the matching PDFs.
  - `ensemble.ts.<id>.<variable>.<years>.pdf`: Time series plots showing mean and 95% CI of each variable throughout the run.
  - `ensemble.ts.<id>.<variable>.<years>.Rdata`: The extracted datapoints used to make the timeseries PDFs.
  - `out/`: Model outputs, with subdirectories for each ensemble member containing:
    * `<year>.nc`: One PEcAn-standard netCDF per year containing all requested output variables at the same timestep as the input weather data
    * `<year>.nc.var`: One plain text file per year containing a list of the variables included in `<year>.nc`. In this case all years have the same variables, but PEcAn is capable of simulations where variables differ from year to year.
    * `logfile.txt`: Console output from the model run. Note that Sipnet itself is not very chatty, so for successful runs this usually shows only the PEcAn output from the process of converting the output to netCDF.
    * `README.txt`: Reports some metadata about the model run including site, input files, run dates, etc.
    * `sipnet.out`: Raw Sipnet output, with all years and variables in one file
  - `pecan.CONFIGS.xml`: Settings for the run, as recorded just after writing config files and before starting the Sipnet runs (In this workflow only one XML file is written; in other PEcAn applications the settings might be recorded at other stages of the run as well, giving e.g. `pecan.CHECKED.xml`, `pecan.TRAIT.xml`, `pecan.METPROCESS.xml`, and so on).
  - `run/`: Working directories for the execution of each model, with subdirectories for each ensemble member containing:
    * `job.sh`: A bash script that controls the execution of Sipnet and relocates outputs to the `out/` directory
    * `README.txt`: Metadata about the model run; identical to the copy in `out/`
    * `sipnet.clim`: a *link to* the weather data used for this model invocation.
    * `sipnet.in`, `sipnet.param-spatial`: Configuration files used by Sipnet. These are identical for each run, copied into every run directory because Sipnet expects to find them there.
    * `sipnet.param`: Values for Sipnet model parameters, set by starting from Sipnet's default parameter set and updating parameters set in the chosen PFT by taking draws from the PFT's parameter distributions.
  - `samples.Rdata`: The draws from requested parameter distributions that were used to set the Sipnet parameterization of each model in the run.
  - If a sensitivity analysis is requested (by uncommenting the `<sensitivity.analysis>` block in `single_site_almond.xml`), it will add these additional components:
    - `pft/`: Parameter sensitivity and variance decomposition plots from the sensitivity analysis, placed here because PEcAn's sensitivity analysis can be requested for many PFTs at once and is run separately for each one.
    - `sensitivity.output.<id>.<variable>.<years>.Rdata`: Results from the sensitivity analysis, processed and ready for visualization.
    - `sensitivity.results.<id>.<variable>.<years>.Rdata`: Results from the sensitivity simulations, extracted and set up for analysis.
    - `sensitivity.samples.<id>.Rdata`: The parameter values selected for the one-at-a-time sensitivity analysis, with each variable taken at its PFT median plus or minus the standard deviations specified in the settings XML. Note that these same values are also part of `samples.Rdata`.
  - `STATUS`: A plain text file containing start and end timestamps and statuses for each phase of the workflow.
- `tools`: Scripts for occasional use that may or may not be part of every workflow run. At this writing it contains installation scripts for setting up Sipnet and PEcAn on an HPC cluster and for archiving run output; others may be added later.


## References

[1] Fer I, R Kelly, P Moorcroft, AD Richardson, E Cowdery, MC Dietze. 2018. Linking big models to big data: efficient ecosystem model calibration through Bayesian model emulation. Biogeosciences 15, 5801–5830, 2018 https://doi.org/10.5194/bg-15-5801-2018
